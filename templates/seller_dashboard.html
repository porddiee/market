{% extends 'base.html' %}
{% load tz %}
{% block content %}
<h1>Seller Dashboard</h1>
<p class="text-muted">Manage your store: products and incoming orders.</p>

<div class="card p-4 mb-4" style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white;">
  <div class="d-flex justify-content-between align-items-center">
    <div>
      <div class="text-white-50 small">Total Sales</div>
      <h2 style="color: white; margin: 0;">₱{{ sidebar_sales_total|floatformat:2 }}</h2>
    </div>
    <div style="font-size: 48px; opacity: 0.3;">
      <i class="bi bi-graph-up"></i>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-md-6">
    <div class="card p-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">Your Products</h5>
        <a href="{% url 'seller_add_product' %}" class="btn btn-sm btn-success">Add Product</a>
      </div>
      <ul class="list-group list-group-flush">
        {% for p in products %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <div class="fw-bold">{{ p.name }}</div>
              <div class="small text-muted">₱{{ p.price }} / {{ p.unit }} — Stock: {{ p.stock }}</div>
            </div>
            <div>
              <a href="{% url 'seller_edit_product' p.pk %}" class="btn btn-sm btn-outline-secondary me-1">Edit</a>
              <a href="{% url 'seller_delete_product' p.pk %}" class="btn btn-sm btn-outline-danger">Delete</a>
            </div>
          </li>
        {% empty %}
          <li class="list-group-item">No products yet.</li>
        {% endfor %}
      </ul>
    </div>
  </div>

  <div class="col-md-6">
    <div class="card p-3">
      <h5>Pending Orders</h5>
      {% for o in pending %}
        <div class="border rounded p-2 mb-2">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="fw-bold">Order {{ o.order_number }}</div>
              <div class="small text-muted">Buyer: {{ o.buyer }} — {% timezone "Asia/Manila" %}{{ o.created_at|date:"M d, Y, g:i A" }}{% endtimezone %}</div>
              <div class="small text-muted mt-1"><i class="bi bi-telephone"></i> <strong>{{ o.buyer.phone_number|default:'No phone' }}</strong></div>
            </div>
            <div style="text-align:right">
              <div class="status-pill {% if o.status == 'pending' %}status-pending{% elif o.status == 'confirmed' %}status-confirmed{% elif o.status == 'shipped' %}status-shipped{% elif o.status == 'delivered' %}status-delivered{% elif o.status == 'cancelled' %}status-cancelled{% endif %}">
                {% if o.status == 'pending' %}<i class="bi bi-clock-history"></i>{% elif o.status == 'confirmed' %}<i class="bi bi-check-circle"></i>{% elif o.status == 'shipped' %}<i class="bi bi-truck"></i>{% elif o.status == 'delivered' %}<i class="bi bi-box-seam"></i>{% elif o.status == 'cancelled' %}<i class="bi bi-x-circle"></i>{% endif %}
                <span style="margin-left:6px; text-transform:capitalize">{{ o.status }}</span>
              </div>
              <form method="post" action="{% url 'seller_update_order_status' o.pk %}" class="mt-2">
                {% csrf_token %}
                <select name="status" class="form-select form-select-sm mb-2">
                  <option value="confirmed">Confirm</option>
                  <option value="shipped">Mark Shipped</option>
                  <option value="delivered">Mark Delivered</option>
                  <option value="cancelled">Cancel</option>
                </select>
                <button class="btn btn-sm btn-primary">Update</button>
              </form>
            </div>
          </div>
          <div class="small mt-2">
            {% for it in o.items.all %}
              {% if it.product.seller == user %}
                <div>{{ it.quantity }} x {{ it.product.name }}</div>
              {% endif %}
            {% endfor %}
          </div>
        </div>
      {% empty %}
        <p class="text-muted">No pending orders.</p>
      {% endfor %}

      <h5 class="mt-3">All Orders</h5>
      <ul class="list-group">
        {% for o in orders %}
          <li class="list-group-item">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="fw-bold">{{ o.order_number }}</div>
                <div class="small text-muted">Buyer: {{ o.buyer }}</div>
                <div class="mt-1"><small class="text-muted">Placed: {% timezone "Asia/Manila" %}{{ o.created_at|date:"M d, Y, g:i A" }}{% endtimezone %}</small></div>
                <div class="mt-1 small text-muted"><i class="bi bi-telephone"></i> <strong>{{ o.buyer.phone_number|default:'No phone' }}</strong></div>
                <div class="mt-1">
                  <span class="status-pill {% if o.status == 'pending' %}status-pending{% elif o.status == 'confirmed' %}status-confirmed{% elif o.status == 'shipped' %}status-shipped{% elif o.status == 'delivered' %}status-delivered{% elif o.status == 'cancelled' %}status-cancelled{% endif %}">{{ o.status }}</span>
                </div>
                <div class="small mt-2">
                  {% for it in o.items.all %}
                    {% if it.product.seller == user %}
                      <div>{{ it.quantity }} x {{ it.product.name }}</div>
                    {% endif %}
                  {% endfor %}
                </div>
              </div>
              <div style="text-align:right; min-width: 180px;">
                <form method="post" action="{% url 'seller_update_order_status' o.pk %}" class="mb-2">
                  {% csrf_token %}
                  <select name="status" class="form-select form-select-sm mb-2">
                    <option value="">-- Select status --</option>
                    <option value="pending">Pending</option>
                    <option value="confirmed">Confirmed</option>
                    <option value="shipped">Shipped</option>
                    <option value="delivered">Delivered</option>
                    <option value="cancelled">Cancelled</option>
                  </select>
                  <button class="btn btn-sm btn-primary w-100 mb-2">Update</button>
                </form>
                <a href="{% url 'order_detail' o.pk %}" class="btn btn-sm btn-outline-secondary w-100">View Details</a>
              </div>
            </div>
          </li>
        {% empty %}
          <li class="list-group-item">No orders yet.</li>
        {% endfor %}
      </ul>
    </div>
  </div>
</div>

{% endblock %}
